【対話で学ぶ】Playwright の CI 失敗を 30 分で潰す実践ガイド

副題: タイムアウト・セレクタ・環境差・並列競合を「会話」で片付ける

導入

（小さなミーティングルーム。ユイがノート PC をレンに見せる）

ユイ: 「先輩、CI で E2E テストがよく落ちて…毎回ログを読むのに 1 時間かかります。」

レン: 「よくある話だ。今日は失敗を『時間／セレクタ／環境／並列』の 4 つの観点で分類して、Copilot Chat を相棒に 30 分で次の一手を決める流れを試そう。」

この記事はユイとレンの対話を軸に進む。会話で出るプロンプトや修正例は、そのままコピペして試せるようになっている。

要約（TL;DR）：CI の E2E テスト失敗を 4 つの観点で分類し、優先順位付きで「今すぐやること」を決めるテンプレを学ぶ。

登場人物と今日のゴール

ユイ: Playwright を始めて 3 か月のエンジニア。現場で落ちるテストに悩む。

レン: QA/Automation リード。原因切り分けと最短対処が得意。

次は 4 つの典型パターンを順に扱う。それぞれ、会話 → 要点 → 実行例 の順で短くまとめる。

失敗パターン 1: タイムアウト地獄からの脱出

要約（TL;DR）：固定待機を条件待機に変えるだけで、多くの Timeout 問題は解消します。

症状

TimeoutError: waiting for selector ...

遅い環境のみ再現、まれに成功する

会話

（ユイが画面のタイムアウトログをレンに見せる）

ユイ: 「特定の操作で時々 TimeoutError が発生します。ローカルは通るのに CI だけ落ちることが多く、`waitForTimeout(5000)` を入れても直りません。」

レン: 「多くは固定待機が原因だ。場当たり的な `waitForTimeout` はやめて、要素や描画を待つ『条件待ち』に置き換えると効果が出やすい。`state: 'visible'` や `waitForURL()` を組み合わせると堅くなるよ。」

ユイ: 「まずは `waitForSelector(..., { state: 'visible' })` に置き換えて、どのフェーズで遅延が出るかログを追加してみます。」

レン: 「ログで遅いフェーズだけを特定して、そこだけ条件待ちにすれば無駄な待ちがなくなる。」

要点（3 行）

固定待機は最後の手段。条件待ちを優先する。

フェーズごとにログを取り、遅延箇所のみ条件待ちにする。

描画/遷移は `visible` / `waitForURL()` を使うと堅い。

実行例（すぐ使えるプロンプト）

次の Playwright コードで時々 TimeoutError になります。高速/低速環境で安定する待機戦略に書き換えてください。理由も 3 行で。

（※ 問題のテストコードを貼り付け）

修正例（コード）

// ❌ 固定待機
await page.waitForTimeout(5000);
await page.locator("#result").click();

// ⭕ 条件待ち + 自動待機
await page.waitForSelector("#result", { state: "visible" });
await page.getByRole("button", { name: "結果を表示" }).click();

結果 / 次の一手

結果: 条件待ちに変えると CI 上のタイムアウトが明確に減るケースが多い。

次の一手: フェーズ分解ログを取り、最も遅い箇所を優先的に条件待ちに変えて再実行する。

小さな変化が効くケースが多いので、次は『セレクタの選び方』に移る。

失敗パターン 2: セレクタが突然壊れる

要約（TL;DR）：見た目（class/text）に依存するセレクタを避け、role/testid ベースへ置き換えるのが近道です。

症状

class 名や表示テキストに依存しており、デザイン変更や多言語化で壊れる

会話

（ユイが開発者ツールのセレクタを指差す）

ユイ: 「デザイナーが class 名を変えたらテストが全部壊れました。`.btn-primary` を頼りにしていたのがまずかったです。」

レン: 「UI の意味で参照する方が堅牢だ。`getByRole` や `getByTestId` を優先して、i18n は name の正規表現で吸収しよう。」

ユイ: 「Copilot にテンプレ化を頼めば、大量置換も楽ですね。」
要点（3 行）

見た目（class/text）依存を避ける。

`getByRole` / `getByTestId` を優先し、i18n は正規表現で吸収する。

テンプレ化（Copilot）で差分修正を速くする。
【対話で学ぶ】Playwright の CI 失敗を 30 分で潰す実践ガイド

副題: タイムアウト・セレクタ・環境差・並列競合を「会話」で片付ける

導入

（小さなミーティングルーム。ユイがノート PC をレンに見せる）

ユイ: 「先輩、CI で E2E テストがよく落ちて…毎回ログを読むのに 1 時間かかります。」

レン: 「よくある話だ。今日は失敗を『時間／セレクタ／環境／並列』の 4 つの観点で分類して、Copilot Chat を相棒に 30 分で次の一手を決める流れを試そう。」

この記事はユイとレンの対話を軸に進む。会話で出るプロンプトや修正例は、そのままコピペして試せるようになっている。

要約（TL;DR）：CI の E2E テスト失敗を 4 つの観点で分類し、優先順位付きで「今すぐやること」を決めるテンプレを学ぶ。

登場人物と今日のゴール

ユイ: Playwright を始めて 3 か月のエンジニア。現場で落ちるテストに悩む。

レン: QA/Automation リード。原因切り分けと最短対処が得意。

次は 4 つの典型パターンを順に扱う。それぞれ、会話 → 要点 → 実行例 の順で短くまとめる。

失敗パターン 1: タイムアウト地獄からの脱出

要約（TL;DR）：固定待機を条件待機に変えるだけで、多くの Timeout 問題は解消します。

症状

TimeoutError: waiting for selector ...

遅い環境のみ再現、まれに成功する

会話

（ユイが画面のタイムアウトログをレンに見せる）

ユイ: 「特定の操作で時々 TimeoutError が発生します。ローカルは通るのに CI だけ落ちることが多く、`waitForTimeout(5000)` を入れても直りません。」

レン: 「多くは固定待機が原因だ。場当たり的な `waitForTimeout` はやめて、要素や描画を待つ『条件待ち』に置き換えると効果が出やすい。`state: 'visible'` や `waitForURL()` を組み合わせると堅くなるよ。」

ユイ: 「まずは `waitForSelector(..., { state: 'visible' })` に置き換えて、どのフェーズで遅延が出るかログを追加してみます。」

レン: 「ログで遅いフェーズだけを特定して、そこだけ条件待ちにすれば無駄な待ちがなくなる。」

要点（3 行）

固定待機は最後の手段。条件待ちを優先する。

フェーズごとにログを取り、遅延箇所のみ条件待ちにする。

描画/遷移は `visible` / `waitForURL()` を使うと堅い。

実行例（すぐ使えるプロンプト）

次の Playwright コードで時々 TimeoutError になります。高速/低速環境で安定する待機戦略に書き換えてください。理由も 3 行で。

（※ 問題のテストコードを貼り付け）

修正例（コード）

// ❌ 固定待機
await page.waitForTimeout(5000);
await page.locator("#result").click();

// ⭕ 条件待ち + 自動待機
await page.waitForSelector("#result", { state: 'visible' });
await page.getByRole("button", { name: "結果を表示" }).click();

結果 / 次の一手

結果: 条件待ちに変えると CI 上のタイムアウトが明確に減るケースが多い。

次の一手: フェーズ分解ログを取り、最も遅い箇所を優先的に条件待ちに変えて再実行する。

小さな変化が効くケースが多いので、次は『セレクタの選び方』に移る。

失敗パターン 2: セレクタが突然壊れる

要約（TL;DR）：見た目（class/text）に依存するセレクタを避け、role/testid ベースへ置き換えるのが近道です。

症状

class 名や表示テキストに依存しており、デザイン変更や多言語化で壊れる

会話

（ユイが開発者ツールのセレクタを指差す）

ユイ: 「デザイナーが class 名を変えたらテストが全部壊れました。`.btn-primary` を頼りにしていたのがまずかったです。」

レン: 「UI の意味で参照する方が堅牢だ。`getByRole` や `getByTestId` を優先して、i18n は name の正規表現で吸収しよう。」

ユイ: 「Copilot にテンプレ化を頼めば、大量置換も楽ですね。」

要点（3 行）

見た目（class/text）依存を避ける。

`getByRole` / `getByTestId` を優先し、i18n は正規表現で吸収する。

テンプレ化（Copilot）で差分修正を速くする。

実行例（すぐ使えるプロンプト）

次のセレクタを role/testid 中心で安定化してください。i18n でも壊れにくい戦略に。

失敗パターン 3: 環境差（CI とローカルで挙動が異なる）

要約（TL;DR）：環境差はフォント、ロケール、タイムゾーン、依存ライブラリのバージョン差が原因のことが多い。環境を固定化するか、比較可能な最小セットを作ることで不安定さを減らせます。

症状

- ローカルでは通るが CI で失敗する。
- スクリーンショット比較で多数の差分が出る。
- 日付/通貨/ロケール依存のテストが不安定。

会話

（ユイがローカルと CI のスクリーンショットを並べる）

ユイ: 「ローカルと CI の差が原因で、スクショ比較がゴミ判定になります。CI の方がフォントが違うっぽいです。」

レン: 「まずは再現性のある最小セットを作って、差の原因を絞ろう。viewport、フォント、locale、timezone を固定してみて。依存ライブラリのバージョンも CI と一致させるのが基本だ。」

ユイ: 「Playwright の `use` で locale と timezone を固定して、CI コンテナに同じフォントを入れてみます。画像比較は閾値を緩めて様子を見ます。」

要点（3 行）

- viewport/フォント/タイムゾーン/ロケールを固定する。
- CI コンテナに必要なフォントやライブラリを明示的にインストールする。
- 画像比較は閾値を段階的に調整して誤検知を抑える。

実行例（すぐ使えるプロンプト）

CI(ubuntu) とローカル(macOS)でスクショ比較が不安定です。ビューポート/フォント/デバイス設定を最小セットで固定した playwright.config.ts を提案してください。

修正例（設定）

```ts
import { defineConfig, devices } from "@playwright/test";
export default defineConfig({
  use: {
    viewport: { width: 1280, height: 800 },
    deviceScaleFactor: 1,
    locale: "ja-JP",
    timezoneId: "Asia/Tokyo",
    screenshot: "only-on-failure",
    // CI 側のコンテナに必要なフォントをインストールする手順を README に追加する
  },
  projects: [{ name: "chromium", use: { ...devices["Desktop Chrome"] } }],
});
```

結果 / 次の一手

結果: 環境を揃えるだけで多数の“差分”は消える。CI コンテナにフォントを追加し、locale/timezone を固定して再実行しましょう。

次の一手: CI の Dockerfile / runner にフォントや必要ライブラリのインストール手順を追加し、スクリーンショットの閾値を段階的に検証する。

失敗パターン 4: 並列実行での競合

要約（TL;DR）：まずはデータ分離（UUID サフィックス等）で干渉を減らし、残る競合は `serial` へ分離するのが実践的です。

症状

DB ロック、テスト間干渉、共有リソースの競合

会話

ユイ: 「並列で実行すると DB 関連で競合が発生します。ローカルで再現しづらいケースが多いです。」

レン: 「並列競合はデータ分離やロック設計の問題が多いね。まずはテストごとに一時データを分離（UUID サフィックス等）してみて、それでも残るなら該当のテストだけ `serial` にする戦術が有効だよ。」

ユイ: 「まずはデータ分離を導入して、並列度を段階的に上げて閾値を見ます。」

レン: 「ログと再現手順が揃ったら Copilot に '競合原因を優先度付きで 5 案' と頼むと速い。」

要点（3 行）

共有データの書き換えを避け、テストごとに独立データを作る。

並列度を段階的に上げて閾値を把握する。

競合しやすいものは `serial` に切り出す。

実行例（すぐ使えるプロンプト）

並列で落ちる E2E テストを、データ分離と直列化で安定化する設計ガイドを 5 箇条でください。

対策例（チェックリスト）

共有データの書き換え禁止 → 各テストで作成/破棄

CI 並列数を段階的に引き上げ、閾値を把握

競合しやすいシナリオは `serial` プロジェクトで分離

一時ユーザー/テナント名にランダムサフィックスを付与

外部 API はフェイク/モックを優先

ログを“要点化”するテンプレ（共通）

プロンプト（コピペ可）

以下の CI ログから、

1. 根本原因の仮説

2. 再現ステップ

3. 優先度（高/中/低）と先に潰すべき理由

を 10 行以内で整理してください。必要なら修正案のコードも添えてください。

（※ ログ全文を貼り付け）

現場で使えるチェックリスト（10 項目）

固定待機を条件待機へ置換したか（`visible/attached` の選定理由は）

セレクタは `role/testid` 優先か（i18n/デザイン変更で壊れないか）

ビューポート/フォント/タイムゾーンは固定したか

画像比較のしきい値は“現実的”か（誤検知を抑制）

並列で競合するテストを切り出したか（`serial`/タグ）

データ分離（UUID 接尾辞/一時スキーマ/テナント分離）

外部 API はモック化/リトライ設定を適用したか

ログ収集に「原因/再現/優先度」テンプレを使ったか

CI の失敗を 環境/時間/データ の 3 軸で分類したか

再発防止を config/practice に恒久反映したか

まとめ: 30 分で“次に進む”判断を

まずは分類（時間/セレクタ/環境/並列）して、影響の大きいものから順に潰す。

会話（Copilot を含む）で『原因仮説 → 再現 → 修正案』を迅速に作る習慣を持つと工数が減る。

一度テンプレ化すると次回以降はさらに速く回せる。

次回予告 📢

次回は「落ちないテスト設計の実践」。テストデータ設計（境界値/同値分割）、失敗の再現性を上げる戦略、保守しやすい `test.each` パターンを会話形式で紹介します。

シリーズ記事一覧

- Week 1: Copilot Chat の隠れた便利機能 10 選

- Week 2: Playwright の CI 失敗を 30 分で潰す実践ガイド ← 本記事

- Week 3: 落ちないテスト設計の実践（近日公開）

- Week 4: AI × E2E の運用設計（近日公開）

🏷️ Tags

#Playwright #CI #GitHubActions #GitHubCopilot #CopilotChat #テスト自動化 #開発効率化 #ログ解析
