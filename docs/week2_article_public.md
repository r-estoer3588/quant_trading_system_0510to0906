# 【対話で学ぶ】Playwright の CI 失敗を 30 分で潰す実践ガイド

**副題**: タイムアウト・セレクタ・環境差・並列競合を「会話」で片付ける

---

## 導入

（小さなミーティングルーム。ユイがノート PC をレンに見せる）

ユイ: 「先輩、CI で E2E テストがよく落ちて…毎回ログを読むのに 1 時間かかります。」

レン: 「よくある話だ。今日は失敗を『時間／セレクタ／環境／並列』の 4 つの観点で分類して、Copilot Chat を相棒に 30 分で次の一手を決める流れを試そう。」

この記事はユイとレンの対話を軸に進む。会話で出るプロンプトや修正例は、そのままコピペして試せるようになっている。

要約（TL;DR）：CI の E2E テスト失敗を 4 つの観点で分類し、優先順位付きで「今すぐやること」を決めるテンプレを学ぶ。

---

## 登場人物と今日のゴール

- ユイ: Playwright を始めて 3 か月のエンジニア。現場で落ちるテストに悩む。
- レン: QA/Automation リード。原因切り分けと最短対処が得意。

> 今日のゴール
>
> 1. 失敗を 4 軸（時間/セレクタ/環境/並列）で即分類する
> 2. 再現・修正・回避の“次の一手”を 30 分以内に決められるテンプレを持つ

---

次は 4 つの典型パターンを順に扱う。それぞれ、会話 → 要点 → 実行例 の順で短くまとめる。

---

## 失敗パターン 1: タイムアウト地獄からの脱出

要約（TL;DR）：固定待機を条件待機に変えるだけで、多くの Timeout 問題は解消します。

### 症状

- TimeoutError: waiting for selector ...
- 遅い環境のみ再現、まれに成功する

### 会話

（ユイが画面のタイムアウトログをレンに見せる）

ユイ: 「特定の操作で時々 TimeoutError が発生します。ローカルは通るのに CI だけ落ちることが多く、`waitForTimeout(5000)` を入れても直りません。」

レン: 「多くは固定待機が原因だ。場当たり的な `waitForTimeout` はやめて、要素や描画を待つ『条件待ち』に置き換えると効果が出やすい。`state: 'visible'` や `waitForURL()` を組み合わせると堅くなるよ。」

ユイ: 「まずは `waitForSelector(..., { state: 'visible' })` に置き換えて、どのフェーズで遅延が出るかログを追加してみます。」

レン: 「ログで遅いフェーズだけを特定して、そこだけ条件待ちにすれば無駄な待ちがなくなる。」

### 要点（3 行）

1. 固定待機は最後の手段。条件待ちを優先する。
2. フェーズごとにログを取り、遅延箇所のみ条件待ちにする。
3. 描画/遷移は `visible` / `waitForURL()` を使うと堅い。

### 実行例（すぐ使えるプロンプト）

```
次の Playwright コードで時々 TimeoutError になります。高速/低速環境で安定する待機戦略に書き換えてください。理由も 3 行で。

（※ 問題のテストコードを貼り付け）
```

### 修正例（コード）

```ts
// ❌ 固定待機
await page.waitForTimeout(5000);
await page.locator("#result").click();

// ⭕ 条件待ち + 自動待機
await page.waitForSelector("#result", { state: "visible" });
await page.getByRole("button", { name: "結果を表示" }).click();
```

### 結果 / 次の一手

- 結果: 条件待ちに変えると CI 上のタイムアウトが明確に減るケースが多い。
- 次の一手: フェーズ分解ログを取り、最も遅い箇所を優先的に条件待ちに変えて再実行する。

---

小さな変化が効くケースが多いので、次は『セレクタの選び方』に移る。

---

## 失敗パターン 2: セレクタが突然壊れる

要約（TL;DR）：見た目（class/text）に依存するセレクタを避け、role/testid ベースへ置き換えるのが近道です。

### 症状

- class 名や表示テキストに依存しており、デザイン変更や多言語化で壊れる

### 会話

（ユイが開発者ツールのセレクタを指差す）

ユイ: 「デザイナーが class 名を変えたらテストが全部壊れました。`.btn-primary` を頼りにしていたのがまずかったです。」

レン: 「UI の意味で参照する方が堅牢だ。`getByRole` や `getByTestId` を優先して、i18n は name の正規表現で吸収しよう。」

ユイ: 「Copilot にテンプレ化を頼めば、大量置換も楽ですね。」

レン: 「テンプレがあれば次回は差分だけ直せば済むから、保守コストが下がるよ。」

### 要点（3 行）

1. 見た目（class/text）依存を避ける。
2. `getByRole` / `getByTestId` を優先し、i18n は正規表現で吸収する。
3. テンプレ化（Copilot）で差分修正を速くする。

### 実行例（すぐ使えるプロンプト）

```
次のセレクタを role/testid 中心で安定化してください。i18n でも壊れにくい戦略に。

### シリーズ記事一覧

- **Week 1**: [Copilot Chat の隠れた便利機能 10 選](https://note.com/ai_narrative25/n/nd305530c5064)
- **Week 2**: Playwright の CI 失敗を30分で潰す実践ガイド ← 本記事
- **Week 3**: 落ちないテスト設計の実践（近日公開）
- **Week 4**: AI × E2E の運用設計（近日公開）

---

### 🏷️ Tags

 #Playwright #CI #GitHubActions #GitHubCopilot #CopilotChat #テスト自動化 #開発効率化 #ログ解析

---

## 公開前チェック（簡易）

1. スペル・スタイルチェック: コード以外の文書でも気になる表記揺れがあれば修正してください。必要なら外部ツール（例: markdownlint, cspell）や人の校正を推奨します。
2. YAML front-matter の確認: note に貼る前に YAML front-matter (ファイル先頭の '---' ブロック) が含まれていないことを確認してください。

確認結果（私がチェックしました）: このファイルには YAML front-matter（先頭 '---' で始まるブロック）は含まれていませんでした。

(補足）: コード整形ツール（Ruff/Black 等）は Python ソース向けです。本文の最終品質を上げるには、上記のスペル/校正と、note に貼る際は改行や引用の崩れがないかの最終確認をおすすめします。

### プロンプト例

```

CI(ubuntu) とローカル(macOS)でスクショ比較が不安定です。ビューポート/フォント/デバイス設定を最小セットで固定した playwright.config.ts を提案してください。

````

### 設定例（最小）

```ts
import { defineConfig, devices } from "@playwright/test";
export default defineConfig({
  use: {
    viewport: { width: 1280, height: 800 },
    deviceScaleFactor: 1,
    locale: "ja-JP",
    timezoneId: "Asia/Tokyo",
    screenshot: "only-on-failure",
  },
  projects: [{ name: "chromium", use: { ...devices["Desktop Chrome"] } }],
});
````

### 補足

- 画像比較は `maxDiffPixelRatio` などで“許容ノイズ”を定義。

### 実行例（すぐ使えるプロンプト）

```
CI（ubuntu）とローカル（macOS）でスクショ比較が不安定です。ビューポート/フォント/デバイス設定を最小セットで固定した playwright.config.ts を提案してください。
```

### 設定例（最小）

```ts
import { defineConfig, devices } from "@playwright/test";
export default defineConfig({
  use: {
    viewport: { width: 1280, height: 800 },
    deviceScaleFactor: 1,
    locale: "ja-JP",
    timezoneId: "Asia/Tokyo",
    screenshot: "only-on-failure",
  },
  projects: [{ name: "chromium", use: { ...devices["Desktop Chrome"] } }],
});
```

### 結果 / 次の一手

- 結果: CI 環境を固定するだけで多数の差分は消える。画像比較の誤検知を減らせる。
- 次の一手: CI に設定を反映し、閾値を段階的に調整して安定基準を決める。

---

最後は並列実行に伴う競合だ。ここは設計上の対応が必要なケースがある。

---

## 失敗パターン 4: 並列実行での競合

要約（TL;DR）：まずはデータ分離（UUID サフィックス等）で干渉を減らし、残る競合は `serial` へ分離するのが実践的です。

### 症状

- DB ロック、テスト間干渉、共有リソースの競合

### 会話

ユイ: 「並列で実行すると DB 関連で競合が発生します。ローカルで再現しづらいケースが多いです。」

レン: 「並列競合はデータ分離やロック設計の問題が多いね。まずはテストごとに一時データを分離（UUID サフィックス等）してみて、それでも残るなら該当のテストだけ `serial` にする戦術が有効だよ。」

ユイ: 「まずはデータ分離を導入して、並列度を段階的に上げて閾値を見ます。」

レン: 「ログと再現手順が揃ったら Copilot に '競合原因を優先度付きで 5 案' と頼むと速い。」

### 要点（3 行）

1. 共有データの書き換えを避け、テストごとに独立データを作る。
2. 並列度を段階的に上げて閾値を把握する。
3. 競合しやすいものは `serial` に切り出す。

### 実行例（すぐ使えるプロンプト）

```
並列で落ちる E2E テストを、データ分離と直列化で安定化する設計ガイドを 5 箇条でください。
```

### 対策例（チェックリスト）

- 共有データの書き換え禁止 → 各テストで作成/破棄
- CI 並列数を段階的に引き上げ、閾値を把握
- 競合しやすいシナリオは `serial` プロジェクトで分離
- 一時ユーザー/テナント名にランダムサフィックスを付与
- 外部 API はフェイク/モックを優先

---

## ログを“要点化”するテンプレ（共通）

### プロンプト（コピペ可）

```
以下の CI ログから、
1) 根本原因の仮説
2) 再現ステップ
3) 優先度（高/中/低）と先に潰すべき理由
を 10 行以内で整理してください。必要なら修正案のコードも添えてください。

（※ ログ全文を貼り付け）
```

---

## 現場で使えるチェックリスト（10 項目）

1. 固定待機を条件待機へ置換したか（`visible/attached` の選定理由は）
2. セレクタは `role/testid` 優先か（i18n/デザイン変更で壊れないか）
3. ビューポート/フォント/タイムゾーンは固定したか
4. 画像比較のしきい値は“現実的”か（誤検知を抑制）
5. 並列で競合するテストを切り出したか（`serial`/タグ）
6. データ分離（UUID 接尾辞/一時スキーマ/テナント分離）
7. 外部 API はモック化/リトライ設定を適用したか
8. ログ収集に「原因/再現/優先度」テンプレを使ったか
9. CI の失敗を 環境/時間/データ の 3 軸で分類したか
10. 再発防止を config/practice に恒久反映したか

---

## まとめ: 30 分で“次に進む”判断を

- まずは分類（時間/セレクタ/環境/並列）して、影響の大きいものから順に潰す。
- 会話（Copilot を含む）で『原因仮説 → 再現 → 修正案』を迅速に作る習慣を持つと工数が減る。
- 一度テンプレ化すると次回以降はさらに速く回せる。

---

## 次回予告 📢

次回は「落ちないテスト設計の実践」。テストデータ設計（境界値/同値分割）、失敗の再現性を上げる戦略、保守しやすい `test.each` パターンを会話形式で紹介します。

---

### シリーズ記事一覧

- **Week 1**: [Copilot Chat の隠れた便利機能 10 選](https://note.com/ai_narrative25/n/nd305530c5064)
- **Week 2**: Playwright の CI 失敗を 30 分で潰す実践ガイド ← 本記事
- **Week 3**: 落ちないテスト設計の実践（近日公開）
- **Week 4**: AI × E2E の運用設計（近日公開）

---

### 🏷️ Tags (note 用表示)

`#Playwright` `#CI` `#GitHubActions` `#GitHubCopilot` `#CopilotChat` `#テスト自動化` `#開発効率化` `#ログ解析`

---

## 公開前チェック（簡易）

1. スペル・スタイルチェック: コード以外の文書でも気になる表記揺れがあれば修正してください。必要なら外部ツール（例: markdownlint, cspell）や人の校正を推奨します。
2. YAML front-matter の確認: note に貼る前に YAML front-matter (ファイル先頭の '---' ブロック) が含まれていないことを確認してください。

確認結果（私がチェックしました）: このファイルには YAML front-matter（先頭 '---' で始まるブロック）は含まれていませんでした。

（補足）: コード整形ツール（Ruff/Black 等）は Python ソース向けです。本文の最終品質を上げるには、上記のスペル/校正と、note に貼る際は改行や引用の崩れがないかの最終確認をおすすめします。

### プロンプト例

```
CI(ubuntu) とローカル(macOS)でスクショ比較が不安定です。ビューポート/フォント/デバイス設定を最小セットで固定した playwright.config.ts を提案してください。
```

### 設定例（最小）

```ts
import { defineConfig, devices } from "@playwright/test";
export default defineConfig({
  use: {
    viewport: { width: 1280, height: 800 },
    deviceScaleFactor: 1,
    locale: "ja-JP",
    timezoneId: "Asia/Tokyo",
    screenshot: "only-on-failure",
  },
  projects: [{ name: "chromium", use: { ...devices["Desktop Chrome"] } }],
});
```

### 補足

- 画像比較は `maxDiffPixelRatio` などで“許容ノイズ”を定義。

---

## 失敗パターン 4: 並列実行での競合

### 症状

- DB ロック/テスト間干渉/共有リソース競合

### 会話（抜粋）

ユイ: 「並列実行にすると DB 関連で競合が発生します。ローカルでは再現しにくいんです。」

レン: 「並列時の干渉はデータ分離かロック設計の問題が多い。まずはテストごとに分離されたデータ（UUID サフィックスなど）を使って干渉を減らし、それでも競合が残るケースは `serial` に切り替えよう。」

ユイ: 「わかりました。まずはデータ分離と、並列度を段階的に上げて閾値を見てみます。」

レン: 「ログと再現手順が揃えば Copilot に '競合原因を 5 つの提案で' と頼んで優先度付きで対策案を作ってもらうと効率的だよ。」

### プロンプト例

```
並列で落ちる E2E テストを、データ分離と直列化で安定化する設計ガイドを 5 箇条でください。
```

### 会話

（レンが白板に簡単な並列図を書く）

ユイ: 「並列で動かすと DB 関連で競合が起きます。ローカル再現が難しいのが悩みです。」

レン: 「データ分離（UUID サフィックス等）で影響範囲を減らし、それでも残る場合は該当テストだけ `serial` に切り出そう。段階的に並列度を上げて閾値を把握するのが実務的だ。」

ユイ: 「ログ取りと再現手順を整えてから Copilot に優先度付きの対策案を出してもらいます。」

### プロンプト（コピペ可）

```
以下の CI ログから、
1) 根本原因の仮説
2) 再現ステップ
3) 優先度（高/中/低）と先に潰すべき理由
を 10 行以内で整理してください。必要なら修正案のコードも添えてください。

（※ ログ全文を貼り付け）
```

---

## 現場で使えるチェックリスト（10 項目）

1. 固定待機を条件待機へ置換したか（`visible/attached` の選定理由は）
2. セレクタは role/testid 優先か（i18n/デザイン変更で壊れないか）
3. ビューポート/フォント/タイムゾーンは固定したか
4. 画像比較のしきい値は“現実的”か（誤検知を抑制）
5. 並列で競合するテストを切り出したか（serial/タグ）
6. データ分離（UUID 接尾辞/一時スキーマ/テナント分離）
7. 外部 API はモック化/リトライ設定を適用したか
8. ログ収集に「原因/再現/優先度」テンプレを使ったか
9. CI の失敗を 環境/時間/データ の 3 軸で分類したか
10. 再発防止を config/practice に恒久反映したか

---

## まとめ: 30 分で“次に進む”判断を

- 4 パターンの観点で分類 → 再現・修正・回避を素早く決定
- Copilot Chat は「読み解き」と「設計の比較検討」を加速
- 仕組みの反映（config/テンプレ/命名規則）で再発を止める

---

## 次回予告 📢

次回は「落ちないテスト設計の実践」。テストデータ設計（境界値/同値分割）、失敗の再現性を上げる戦略、保守しやすい `test.each` パターンを、会話で一気に形にします。

---

### シリーズ記事一覧

- **Week 1**: [Copilot Chat の隠れた便利機能 10 選](https://note.com/ai_narrative25/n/nd305530c5064)
- **Week 2**: Playwright の CI 失敗を 30 分で潰す実践ガイド ← 本記事
- **Week 3**: 落ちないテスト設計の実践（近日公開）
- **Week 4**: AI × E2E の運用設計（近日公開）

---

### 🏷️ Tags (note 用表示)

`#Playwright` `#CI` `#GitHubActions` `#GitHubCopilot` `#CopilotChat` `#テスト自動化` `#開発効率化` `#ログ解析`
