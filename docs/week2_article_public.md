# 【対話で学ぶ】Playwright の CI 失敗を 30 分で潰す実践ガイド

_副題: タイムアウト・セレクタ・環境差・並列競合を「会話」で片付ける_

## リード

（小さなミーティングルーム。ユイがノート PC をレンに見せる）

ユイ: 「先輩、CI で E2E テストがよく落ちて…毎回ログを読むのに 1 時間かかります。」

レン: 「よくある話だ。今日は失敗を『時間／セレクタ／環境／並列』の 4 つに分類して、Copilot Chat を相棒に 30 分で次の一手を決める流れを試そう。」

この記事はユイとレンの対話で進みます。会話で出るプロンプトや修正例は、そのままコピー＆ペーストして試せます。

**TL;DR**: CI の E2E テスト失敗を「時間／セレクタ／環境／並列」の 4 因子に分類し、影響の大きいものから優先的に対処するための『今すぐやること』テンプレを学べます。短く読めて、すぐ試せます。

### 登場人物とゴール

- **ユイ**: Playwright を始めて 3 か月のエンジニア。現場で落ちるテストに悩む。
- **レン**: QA/Automation リード。原因切り分けと最短対処が得意。

---

## この記事の使い方（短い目次）

1. 失敗パターン 1: タイムアウト
2. 失敗パターン 2: セレクタ
3. 失敗パターン 3: 環境差
4. 失敗パターン 4: 並列競合
5. 現場で使えるチェックリスト

各章は「会話 → 要点（TL;DR）→ 症状 → 実行例 → 修正例 → 次の一手」の順で短くまとめます。

---

## 失敗パターン 1: タイムアウト

### TL;DR

固定待機（waitForTimeout）を条件待機に変えるだけで、多くの Timeout 問題は解消します。

### 症状

- `TimeoutError: waiting for selector ...`
- 遅い環境のみ再現、まれに成功する

### 会話（抜粋）

ユイ: 「特定の操作で時々 TimeoutError が発生します。ローカルは通るのに CI だけ落ちることが多いです。」

レン: 「場当たり的な固定待機はやめて、要素や描画を待つ『条件待ち』に置き換えよう。`state: 'visible'` や `waitForURL()` を組み合わせると堅くなる。」

### 実行例（コピペで使えるプロンプト）

次の Playwright コードで時々 TimeoutError になります。高速/低速環境で安定する待機戦略に書き換えてください。理由も 3 行で。

（※ 問題のテストコードを貼り付け）

### 修正例（コード）

```js
// ❌ 固定待機
await page.waitForTimeout(5000);
await page.locator("#result").click();

// ✅ 条件待ち + 自動待機
await page.waitForSelector("#result", { state: "visible" });
await page.getByRole("button", { name: "結果を表示" }).click();
```

### 結果 / 次の一手

- 結果: 条件待ちに変えると CI 上のタイムアウトは明確に減ることが多い。
- 次の一手: フェーズ分解ログを取り、最も遅い箇所を優先的に条件待ちに変えて再実行する。

---

**--- ↑ ここまで無料（試し読み）↑ ---**

### 今すぐ試せるクイックチェック（3 分以内）

1. 固定待機（waitForTimeout）をまずは条件待機に置き換える。
2. 失敗が UI の変更で起きているか、セレクタ依存かを確認する。
3. スクショ差分が出る場合はフォント／ロケールを揃えてみる。

---

## 続き（有料パート）

**この先の詳細（失敗パターン 2〜4、拡張チェックリスト、テンプレ・設定ファイル、ダウンロード資産）は購入でアンロックされます。**

購入で得られる主要コンテンツ例：

- 失敗パターン 2〜4 の詳細＋実践テンプレ（コピペ可）
- `playwright.config.ts`（最小セット）と CI Dockerfile のテンプレ
- Nano Banana 用プロンプト集（.txt）
- 1280×670 eyecatch PNG + 透過タイトルバンド PNG
- 印刷/配布用チェックリスト PDF

ダウンロード資産例（ファイルは記事配下の `docs/downloads/` に配置しています）:

- `docs/downloads/playwright.config.example.ts`（最小セット）
- `docs/downloads/ci.Dockerfile.example`（CI runner 用テンプレ）
- `docs/downloads/nano_banana_prompts_playwright-ci-30.txt`（プロンプト集）
- `docs/downloads/eyecatch_week2_1280x670.png` / `docs/downloads/eyecatch_week2_titleband.png`
- `docs/downloads/checklist_week2.pdf`（印刷用）

注記（ファイル形式・目安サイズ）:

- `playwright.config.example.ts` — TypeScript 設定例（約 2 KB）
- `ci.Dockerfile.example` — Dockerfile テンプレ（約 1 KB）
- `nano_banana_prompts_playwright-ci-30.txt` — テキスト（約 4 KB）
- `eyecatch_week2_1280x670.png` — PNG（1280×670、約 60 KB）
- `eyecatch_week2_titleband.png` — PNG（透過、約 35 KB）
- `checklist_week2.pdf` — A4 PDF（日本語埋め込みフォント、約 53 KB）

- ダウンロード（購入者向け ZIP）: [week2_paid_assets.zip](https://drive.google.com/file/d/1xP2VHXau6dNkbKbjpvClyudCO327Ku00/view?usp=sharing)

---

<!-- 有料パート開始 -->

## 有料パート（購入者向け）

以下は購入者向けのフルコンテンツです。購入後はこのセクション全文とダウンロード資産がアンロックされます。

## 失敗パターン 2: セレクタが突然壊れる

### TL;DR

見た目（class/text）に依存するセレクタを避け、`getByRole` / `getByTestId` を優先するのが近道です。

### 症状

- class 名や表示テキストに依存しており、デザイン変更や多言語化で壊れる

### 会話（抜粋）

ユイ: 「デザイナーが class 名を変えたらテストが全部壊れました。」

レン: 「UI の意味で参照する方が堅牢だ。`getByRole` や `getByTestId` を優先し、i18n は name の正規表現で吸収しよう。」

### 実行例（コピペで使えるプロンプト）

次のセレクタを role/testid 中心で安定化してください。i18n でも壊れにくい戦略に。

### 要点（3 行）

- 見た目（class/text）依存を避ける。
- `getByRole` / `getByTestId` を優先し、i18n は正規表現で吸収する。
- テンプレ化（Copilot）で差分修正を速くする。

---

## 失敗パターン 3: 環境差（CI とローカルで挙動が異なる）

### TL;DR

フォント、ロケール、タイムゾーン、依存ライブラリのバージョン差が多くの差分を生みます。環境を固定化するか、比較可能な最小セットを作りましょう。

### 症状

- ローカルでは通るが CI で失敗する。
- スクリーンショット比較で多数の差分が出る。
- 日付/通貨/ロケール依存のテストが不安定。

### 会話（抜粋）

ユイ: 「ローカルと CI の差でスクショ比較がゴミ判定になります。CI の方がフォントが違うっぽいです。」

レン: 「まずは再現性のある最小セットを作って、viewport／フォント／locale／timezone を固定してみよう。CI の依存ライブラリも合わせるのが基本だ。」

### 実行例（コピペで使えるプロンプト）

CI(ubuntu) とローカル(macOS)でスクショ比較が不安定です。ビューポート／フォント／デバイス設定を最小セットで固定した `playwright.config.ts` を提案してください。

### 修正例（設定例）

```ts
import { defineConfig, devices } from "@playwright/test";
export default defineConfig({
  use: {
    viewport: { width: 1280, height: 800 },
    deviceScaleFactor: 1,
    locale: "ja-JP",
    timezoneId: "Asia/Tokyo",
    screenshot: "only-on-failure",
    // CI 側のコンテナに必要なフォントをインストールする手順を README に追加する
  },
  projects: [{ name: "chromium", use: { ...devices["Desktop Chrome"] } }],
});
```

### 結果 / 次の一手

- 結果: 環境を揃えるだけで多くの“差分”は消えます。
- 次の一手: CI の Dockerfile / runner にフォントや必要ライブラリのインストール手順を追加し、スクリーンショットの閾値を段階的に検証してください。

---

## 失敗パターン 4: 並列実行での競合

### TL;DR

まずはデータ分離（UUID サフィックス等）で干渉を減らし、残る競合は `serial` に分離するのが実践的です。

### 症状

- DB ロック、テスト間干渉、共有リソースの競合

### 会話（抜粋）

ユイ: 「並列で実行すると DB 関連で競合が発生します。ローカルで再現しづらいケースが多いです。」

レン: 「まずはテストごとに一時データを分離（UUID サフィックス等）してみて、それでも残るなら該当のテストだけ `serial` にする戦術が有効だよ。」

### 実行例（コピペで使えるプロンプト）

並列で落ちる E2E をデータ分離と直列化で安定化する設計ガイドを 5 箇条でください。

### 要点（チェックリスト例）

- 共有データの書き換え禁止 → 各テストで作成/破棄
- CI 並列数を段階的に引き上げ、閾値を把握
- 競合しやすいシナリオは `serial` プロジェクトで分離
- 一時ユーザー/テナント名にランダムサフィックスを付与
- 外部 API はフェイク/モックを優先

---

## 拡張チェックリスト（購入者向け、注釈付き）

1. 固定待機を条件待機へ置換したか（`visible/attached` の選定理由を記載）
2. セレクタを `role/testid` 優先に置き換えたか（変更前/後の例を保存）
3. ビューポート／フォント／タイムゾーンは固定したか（CI の Dockerfile 例あり）
4. 画像比較のしきい値は現実的か（差分例と閾値ガイドを提供）
5. 並列で競合するテストを切り出したか（`serial`/タグ）
6. データ分離（UUID 接尾辞/一時スキーマ/テナント分離）を実装したか
7. 外部 API はモック化/フェイルセーフ/リトライを適用したか
8. ログ収集に「原因/再現/優先度」テンプレを使ったか（テンプレ付き）
9. CI の失敗を 環境/時間/データ の 3 軸で分類したか（記録例あり）
10. 再発防止を config/practice に恒久反映したか（PR テンプレ案あり）

---

## ダウンロード資産（購入で提供）

-
- **購入はこちら（ZIP をダウンロード）** — 含まれる主なファイルと簡易メタ情報を下に記載しています。
-
- `playwright.config.ts`（最小セット） — TypeScript 設定例
- `ci/Dockerfile`（CI runner 用テンプレ）
- `nano_banana_prompts_playwright-ci-30.txt`（プロンプト集）
- `eyecatch_week2_1280x670.png` / `eyecatch_week2_titleband.png`
- `checklist_week2.pdf`（印刷用、10 項目の拡張版）

※ 実際の配布形式は販売プラットフォームに合わせます（ファイル名は例）。

---

## 購入方法と注意点

1. 購入すると「有料パート」がアンロックされ、上記ファイルがダウンロード可能になります。
2. プラットフォーム（note 等）に合わせてリンクを配置します。URL をここに貼るか、購入後の自動配布を想定してください。
3. 追加質問や軽微な更新は購入者向けに 1 回無料で対応するオプションを付けられます（希望する場合は設定します）。

---

## まとめ: 30 分で“次に進む”判断を

まずは分類（時間/セレクタ/環境/並列）して、影響の大きいものから 1 つ選び、5 分でできる対処を試してください。会話（Copilot を含む）で『原因仮説 → 再現 → 修正案』を素早く作る習慣をつけると工数が減ります。

## 次回予告 📢

次回は「落ちないテスト設計の実践」。テストデータ設計（境界値/同値分割）、失敗の再現性を上げる戦略、保守しやすい `test.each` パターンを会話形式で紹介します。

## シリーズ記事一覧

- Week 1: Copilot Chat の隠れた便利機能 10 選
- Week 2: Playwright の CI 失敗を 30 分で潰す実践ガイド ← 本記事
- Week 3: 落ちないテスト設計の実践（近日公開）
- Week 4: AI × E2E の運用設計（近日公開）

🏷️ Tags

#Playwright #CI #GitHubActions #GitHubCopilot #CopilotChat #テスト自動化 #開発効率化 #ログ解析
