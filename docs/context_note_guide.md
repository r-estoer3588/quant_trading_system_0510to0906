# Context Note 追記ガイド

## 📋 概要

このドキュメントは、新規ファイル追加時・大規模リファクタリング時に各ソースファイルの先頭に記載する **「Context Note」** のテンプレート・ルール・実装例を提供します。

Context Note により、Copilot や開発者が設計意図・前提条件・禁止事項を素早く把握でき、より正確な提案・レビューが可能になります。

---

## 🎯 Context Note の役割

| シーン               | 対象                               | 効果                     |
| -------------------- | ---------------------------------- | ------------------------ |
| コード変更前         | ファイルの役割・前提条件・禁止事項 | 設計をズレさせない       |
| Copilot 相談時       | Context Note の内容                | 文脈を把握した正確な提案 |
| レビュー・デバッグ時 | README.md の抽象情報を補足         | 具体的なガイドとして機能 |

---

## 📝 テンプレート（統一フォーマット）

すべてのソースファイル先頭に以下フォーマットで記載してください（言語によって先頭のコメント記号は変更）。

### Python ファイル

```python
# ============================================================================
# 🧠 Context Note
# このファイルは【役割・責務を簡潔に記述（1文）】
#
# 前提条件：
#   - 【設計前提 1】
#   - 【設計前提 2】
#   - 【設計前提 3】（必要なだけ追加）
#
# ロジック単位：
#   function_name()  → 【役割・責務】
#   class_name()     → 【役割・責務】
#
# Copilot へ：
#   → 【重点領域 1】を最優先に提案してください
#   → 【禁止事項】は絶対に変更しないこと
#   → 【其の他注意点】
# ============================================================================
```

### JavaScript / TypeScript ファイル

```typescript
// ============================================================================
// 🧠 Context Note
// このファイルは【役割・責務を簡潔に記述（1文）】
//
// 前提条件：
//   - 【設計前提 1】
//   - 【設計前提 2】
//
// ロジック単位：
//   functionName()  → 【役割・責務】
//
// Copilot へ：
//   → 【重点領域】を最優先に提案してください
// ============================================================================
```

### SQL ファイル

```sql
-- ============================================================================
-- 🧠 Context Note
-- このファイルは【役割・責務】
--
-- 前提条件：
--   - 【設計前提 1】
--   - 【設計前提 2】
--
-- Copilot へ：
--   → 【重点領域】を最優先に提案してください
-- ============================================================================
```

---

## 📂 ファイルカテゴリ別の実装例

### 1️⃣ コアロジック（core/systemX.py）

**ポイント**:

- エントリー・ランキング・フィルタロジックに特化
- 前日データ除外・precomputed 指標依存を明示
- 正確性を最優先する旨を記載

**実装例**:

```python
# ============================================================================
# 🧠 Context Note
# このファイルはシステム X のエントリー・ランキング・フィルタロジック専門
#
# 前提条件：
#   - 当日データのため前日終値は除外
#   - ロング/ショート別にフィルター規則が異なる
#   - キャッシュからの指標アクセスは indicator_access.py 経由
#   - フロー: setup() → rank() → signals() の順序実行
#
# ロジック単位：
#   setup()      → 日次セットアップ＆フィルター条件チェック
#   rank()       → スコアリング＆ランキング
#   signals()    → 最終シグナル抽出（フロート型スコア出力）
#
# Copilot へ：
#   → 正確性を最優先。パフォーマンス改善は二次
#   → 前日データ除外ロジックは絶対変更禁止
#   → テスト結果の「candidates 数」の齟齬は即座に報告
# ============================================================================
```

### 2️⃣ UI ラッパー層（strategies/systemX_strategy.py）

**ポイント**:

- core のオーケストレーション・ラッパーに特化
- API 契約（finalize_allocation）を明示
- core との責務分離を強調

**実装例**:

```python
# ============================================================================
# 🧠 Context Note
# このファイルは core/systemX.py を UI 用に適応させるラッパー層
#
# 前提条件：
#   - UI からのシグナル呼び出しフロー: symbol list → setup → rank → signals
#   - ロジックの本体は core/systemX.py。このファイルは orchestration のみ
#   - 最終配分 API は finalize_allocation() で一元化（契約厳守）
#   - 異なる資本配分・ポジション管理を「slots」として受け取る
#
# ロジック単位：
#   generate_signals()    → prepare_data + generate_candidates を順序実行
#   apply_allocation()    → 当日配分・ポジション情報をまとめて finalize_allocation() へ
#
# Copilot へ：
#   → finalize_allocation() の API 契約は変更するな
#   → UI 用の検証は簡潔に。複雑な検査は core/ に任せる
#   → 当日パイプライン内での例外は必ず診断情報付きで報告
# ============================================================================
```

### 3️⃣ 日次パイプライン（scripts/run_all_systems_today.py）

**ポイント**:

- フロー全体の管理者として位置づけ
- テストモード・並列実行・外部 API 処理を明示
- reproducibility の重要性を強調

**実装例**:

```python
# ============================================================================
# 🧠 Context Note
# このファイルは当日シグナル生成全体フロー（symbols → indicators → signals → allocation）の主導者
#
# 前提条件：
#   - フロー: symbol list 読込 → キャッシュロード → 指標計算 → 各システム実行 → ランキング → 最終配分
#   - 並列実行は --parallel フラグで可能（workers 数は環境設定）
#   - テストモード --test-mode mini で 5 銘柄相当の検証
#   - 外部 API 呼び出しは --skip-external で無効化可能（テスト用）
#
# ロジック単位：
#   load_symbols()      → シンボル一覧ロード
#   run_systems()       → 各システム並列実行
#   finalize()          → 最終配分＆シグナル CSV 出力
#   notify()            → 進捗通知（ENABLE_PROGRESS_EVENTS）
#
# Copilot へ：
#   → テストモードで reproducible であることを最優先
#   → 並列実行の同期タイミングは必ず verify してから提案
#   → --benchmark フラグは診断用。本番コマンドに含めない
# ============================================================================
```

### 4️⃣ キャッシュ・共通層（common/cache_manager.py）

**ポイント**:

- I/O 統一・キャッシュ層の設計方針を明示
- 直接アクセス禁止を強調
- 多層構造の解決順序を記載

**実装例**:

```python
# ============================================================================
# 🧠 Context Note
# このファイルはデータキャッシュ層の総合管理。層: full_backup → base（指標付与済） → rolling（当日用）
#
# 前提条件：
#   - キャッシュ I/O は CacheManager 経由のみ。data_cache/ の直参照・直接書込禁止
#   - rolling: 当日を含む直近 N 日。base: 指標付与済フルセット。full_backup: 原本
#   - 解決順序: today は rolling → base → full_backup。backtest は base → full_backup
#   - Feather フォーマット固有の制約（日付インデックス）を厳格に守る
#
# ロジック単位：
#   load()       → 多層キャッシュから適切に選択・ロード
#   save()       → 階層別に適切なフォーマットで保存
#   validate()   → インデックス＆スキーマ検証
#
# Copilot へ：
#   → キャッシュ層設計の変更は禁止。拡張は新メソッドで
#   → バージョン互換性チェックは必ず含める
#   → "今日のデータがない" は正常。エラーと混同するな
# ============================================================================
```

### 5️⃣ UI アプリケーション（apps/app_integrated.py）

**ポイント**:

- UI の責務・タブ設計を明示
- Playwright 自動化との連携を記載
- 体感スピード重視の旨を強調

**実装例**:

```python
# ============================================================================
# 🧠 Context Note
# このファイルは Streamlit 統合ダッシュボード。各システムのタブ + Metrics + Setup テスト等の集約UI
#
# 前提条件：
#   - 当日シグナル実行は strategies/systemX_strategy.py を呼び出し（finalize_allocation 経由）
#   - UI 進捗表示は ENABLE_PROGRESS_EVENTS=1 で有効化
#   - スクリーンショット自動化は Playwright で完全自動（tools/run_and_snapshot.ps1）
#
# ロジック単位：
#   render_integrated_tab()    → 当日シグナル実行ボタン＆結果表示
#   render_metrics_tab()       → daily_metrics.csv から推移グラフ
#   render_positions_tab()     → ポジション管理 UI
#
# Copilot へ：
#   → UI の体感スピード重視。重い処理は @st.cache_data で最適化
#   → ボタンクリック後の待機は Playwright で自動検出
#   → スクリーンショット撮影タイミングの信頼性を最優先
# ============================================================================
```

### 6️⃣ ⚠️ 特殊ファイル（core/system7.py）

**ポイント**:

- SPY 固定・ヘッジ専用であることを最初に強調
- 変更禁止項目を明確に列挙
- 設計意図（ダウンサイド保護）を記載

**実装例**:

```python
# ============================================================================
# 🧠 Context Note
# このファイルは System7（SPY ショート カタストロフィー・ヘッジ）のロジック専門
#
# ⚠️ CRITICAL: System7 は SPY 固定のヘッジ専用。ロジック変更や SPY 以外の割当は禁止
#
# 前提条件：
#   - SPY のみを対象（他銘柄への適用は禁止）
#   - ポートフォリオ全体のダウンサイドヘッジ（トレード資本の 20%）
#   - マーケット暴落時の損失軽減目的
#   - 指標は precomputed のみ使用
#
# ロジック単位：
#   prepare_data_vectorized_system7() → SPY データ準備
#   generate_candidates_system7()     → 空売りシグナル生成
#
# Copilot へ：
#   → SPY 以外の銘柄割当提案は絶対受け入れるな
#   → system7.py のロジック変更は、必ず Core Team で事前合意必須
#   → ヘッジ目的を忘れずに。収益最大化ではなく損失軽減が目的
# ============================================================================
```

---

## ✅ チェックリスト（Context Note 追記前）

新規ファイル・リファクタリング前に以下を確認してください：

- [ ] ファイルの**最主要な役割**を 1 文で説明できるか
- [ ] **設計前提**が 2 件以上明記されているか
- [ ] **ロジック単位**（関数・クラス）が複数挙げられているか
- [ ] **Copilot へのガイド**（重点領域・禁止事項）が記載されているか
- [ ] System7 など**特殊ファイルに ⚠️ マーク**を付けているか
- [ ] README.md の**階層化（抽象 → 具体）** が機能しているか

---

## 🔧 実装手順

### パターン 1: 新規ファイル追加時

1. ファイルテンプレートを上記から選択
2. 該当カテゴリの実装例を参考に、役割・前提・ロジック単位を埋める
3. Copilot ガイドを記載（最低 2 件）
4. PR に「Context Note 追加」を明記する

### パターン 2: 大規模リファクタリング時

1. 影響を受けるファイルのリストを作成
2. 各ファイルの Context Note を確認（更新が必要か）
3. 設計変更に伴う前提条件の変更を記載
4. テスト実行後、PR に「Context Note 更新」を記載

### パターン 3: Context Note の見直し・最適化

定期的（月 1 回程度）に以下を確認：

- Context Note が実装と乖離していないか
- 新しく判明した前提条件が反映されているか
- Copilot ガイドが効果的か

---

## 📌 よくある間違い

| 間違い                              | 理由                       | 修正方法                                            |
| ----------------------------------- | -------------------------- | --------------------------------------------------- |
| Context Note が長すぎる（5 行以上） | 実装者が読まなくなる       | 最短で記載。詳細は README / 関連ドキュメント参照    |
| 「汎用ユーティリティ」と曖昧に書く  | 役割が不明確               | 具体的な関数・クラスを 3 つ以上挙げる               |
| 禁止事項がない                      | 後で誤変更される確率が高い | 最低 1 件の「絶対変更禁止」項目を記載               |
| Docstring と重複している            | 管理コスト増加             | Docstring は詳細説明、Context Note は設計意図・前提 |
| コメント記号が不統一                | 見つけ難くなる             | `# ===` / `// ===` で統一                           |

---

## 📖 参考資料

- [README.md - Context Note 形式](../README.md#-context-note-形式)
- [copilot-instructions.md](../../.github/copilot-instructions.md) - Copilot の開発ガイド
- [各システムの Context Note 実装例](../../core/system1.py) （ファイル先頭）

---

## 💬 質問・議論

Context Note の追加・見直しに関する質問・提案は以下で受け付けます：

- PR コメント: 当該ファイルの Context Note に疑問がある場合
- GitHub Issues: 全体の方針・テンプレート改善についての議論
- Slack/ミーティング: リアルタイム相談

---

**最終更新**: 2025 年 11 月 1 日
**担当**: AI Development Team
