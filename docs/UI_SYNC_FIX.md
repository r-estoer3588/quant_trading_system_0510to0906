# UI é€²æ—ãƒãƒ¼ã¨ãƒ­ã‚°ã®åŒæœŸå•é¡Œä¿®æ­£

## å•é¡Œã®æ¦‚è¦

**å ±å‘Šã•ã‚ŒãŸå•é¡Œ**:

- UI é€²æ—ãƒãƒ¼ã®è¡¨ç¤ºãŒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã¨åŒæœŸã—ã¦ã„ãªã„
- é€²æ—ãŒæˆ»ã‚‹ç¾è±¡ãŒç™ºç”Ÿã™ã‚‹
- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º (`Tgt`, `FILpass`, `STUpass`, `TRDlist`, `Entry`) ãŒ JSONL é€²æ—ã‚¤ãƒ™ãƒ³ãƒˆã¨ä¸€è‡´ã—ãªã„

## æ ¹æœ¬åŸå› 

1. **é€²æ—å¾Œé€€ã®åŸå› **:

   - `GLOBAL_STAGE_METRICS.get_snapshot()` ã‹ã‚‰å–å¾—ã—ãŸå€¤ãŒå¤ã„å ´åˆã€ä¸¦åˆ—å®Ÿè¡Œã§è¤‡æ•°ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒç«¶åˆã™ã‚‹ã¨é€²æ—ãŒæˆ»ã‚‹
   - `max(prev, value)` ã§ã‚‚ã€å¤ã„å€¤ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ã£ãŸ

2. **ãƒ­ã‚°ä¸ä¸€è‡´ã®åŸå› **:
   - UI è¡¨ç¤ºã¯ `metrics_store` (ãƒ¡ãƒ¢ãƒªå†…ã®çŠ¶æ…‹) ã‹ã‚‰å–å¾—
   - JSONL é€²æ—ã‚¤ãƒ™ãƒ³ãƒˆ (`logs/progress_today.jsonl`) ã¨ã¯åˆ¥ç³»çµ±ã§ç®¡ç†ã•ã‚Œã¦ã„ãŸ
   - ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯çµŒç”±ã®æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ JSONL æ›¸ãè¾¼ã¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ºãƒ¬ã¦ã„ãŸ

## å®Ÿè£…ã—ãŸè§£æ±ºç­–

### 1. **é€²æ—å¾Œé€€é˜²æ­¢ã®å¼·åŒ–** (`update_progress()`)

**å¤‰æ›´å‰**:

```python
# é€šå¸¸æ™‚ã¯é€²æ—å¾Œé€€ã‚’é˜²ããŒã€é–‹å§‹æ™‚ï¼ˆphase="start"ï¼‰ã¯ãƒªã‚»ãƒƒãƒˆã‚’è¨±å¯
if phase != "start":
    prev = int(self.states.get(key, 0))
    value = max(prev, value)
self.states[key] = value
```

**å¤‰æ›´å¾Œ**:

```python
# é€²æ—å¾Œé€€é˜²æ­¢: å¸¸ã«å‰å›å€¤ã¨ã®æœ€å¤§å€¤ã‚’æ¡ç”¨
if phase == "start":
    # é–‹å§‹æ™‚ã¯å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
    self.states[key] = 0
    value = 0
else:
    # é€šå¸¸æ™‚ã¯é€²æ—å¾Œé€€ã‚’é˜²ã: å‰å›å€¤ã‚ˆã‚Šå¤§ãã„å ´åˆã®ã¿æ›´æ–°
    prev = int(self.states.get(key, 0))
    if value > prev:
        self.states[key] = value
    else:
        # å¾Œé€€ã™ã‚‹å ´åˆã¯å‰å›å€¤ã‚’ç¶­æŒ
        value = prev
```

**æ”¹å–„ç‚¹**:

- å€¤ãŒå¾Œé€€ã™ã‚‹å ´åˆã€çŠ¶æ…‹ã‚’æ›´æ–°ã›ãšã«å‰å›å€¤ã‚’ç¶­æŒ
- `phase="start"` æ™‚ã®ã¿å¼·åˆ¶çš„ã« 0 ã«ãƒªã‚»ãƒƒãƒˆ
- `phase="done"` æ™‚ã¯å¼·åˆ¶çš„ã« 100 ã«è¨­å®š

### 2. **JSONL é€²æ—ã‚¤ãƒ™ãƒ³ãƒˆã¨ã®åŒæœŸ** (`_sync_from_jsonl_if_needed()`)

**æ–°è¦è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰**:

```python
def _sync_from_jsonl_if_needed(self) -> None:
    """JSONLé€²æ—ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰æœ€æ–°ã®å€™è£œæ•°ã‚’å–å¾—ã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ›´æ–°ã™ã‚‹"""
    # logs/progress_today.jsonl ã‹ã‚‰ system_complete ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿
    # å„ã‚·ã‚¹ãƒ†ãƒ ã® candidates ã‚’ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«åæ˜ 
```

**ã‚¿ã‚¤ãƒŸãƒ³ã‚°**:

- `update_progress()` å®Ÿè¡Œæ™‚ã«æ¯å›å‘¼ã³å‡ºã•ã‚Œã‚‹
- æœ€æ–° 100 ä»¶ã® JSONL ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
- `system_complete` ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å€™è£œæ•°ã‚’æŠ½å‡ºã—ã¦ `TRDlist` ã¨ `Entry` ã‚’æ›´æ–°

### 3. **æœ€çµ‚å€™è£œæ•°ã®åŒæœŸ** (`_sync_final_counts_from_jsonl()`)

**æ–°è¦è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰**:

```python
def _sync_final_counts_from_jsonl(self) -> None:
    """JSONLé€²æ—ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰æœ€çµ‚å€™è£œæ•°ã‚’å–å¾—ã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ›´æ–°ã™ã‚‹"""
    # pipeline_complete ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ final_rows ã‚’å–å¾—
    # system_complete ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å„ã‚·ã‚¹ãƒ†ãƒ ã®å€™è£œæ•°ã‚’å–å¾—
```

**ã‚¿ã‚¤ãƒŸãƒ³ã‚°**:

- `finalize_counts()` å®Ÿè¡Œæ™‚ã«æœ€åˆã«å‘¼ã³å‡ºã•ã‚Œã‚‹
- `refresh_all()` å®Ÿè¡Œæ™‚ã«ã‚‚å‘¼ã³å‡ºã•ã‚Œã‚‹

### 4. **å®šæœŸåŒæœŸã®çµ±åˆ** (`refresh_all()`)

**å¤‰æ›´å‰**:

```python
def refresh_all(self) -> None:
    for name in self.metrics_store.systems():
        self._render_metrics(name)
```

**å¤‰æ›´å¾Œ**:

```python
def refresh_all(self) -> None:
    # ã¾ãšJSONLã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
    try:
        self._sync_final_counts_from_jsonl()
    except Exception:
        pass
    # å…¨ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å†æç”»
    for name in self.metrics_store.systems():
        self._render_metrics(name)
```

## åŒæœŸãƒ•ãƒ­ãƒ¼

```
UIå®Ÿè¡Œé–‹å§‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 0-4: ã‚·ã‚¹ãƒ†ãƒ å‡¦ç†                   â”‚
â”‚                                           â”‚
â”‚ update_progress("system1", "start")       â”‚
â”‚   â†’ é€²æ—ãƒãƒ¼: 0%                          â”‚
â”‚   â†’ _sync_from_jsonl_if_needed()          â”‚
â”‚      â””â”€ JSONLèª­è¾¼ (system_complete)       â”‚
â”‚         â””â”€ TRDlist/Entryæ›´æ–°              â”‚
â”‚                                           â”‚
â”‚ update_progress("system1", phase)         â”‚
â”‚   â†’ é€²æ—ãƒãƒ¼: é€²æ—å€¤æ›´æ–°ï¼ˆå¾Œé€€é˜²æ­¢ï¼‰      â”‚
â”‚   â†’ _sync_from_jsonl_if_needed()          â”‚
â”‚                                           â”‚
â”‚ update_progress("system1", "done")        â”‚
â”‚   â†’ é€²æ—ãƒãƒ¼: 100%                        â”‚
â”‚   â†’ _sync_from_jsonl_if_needed()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 5-6: é…åˆ†ãƒ»ä¿å­˜                     â”‚
â”‚                                           â”‚
â”‚ finalize_counts()                         â”‚
â”‚   â†’ _sync_final_counts_from_jsonl()       â”‚
â”‚      â””â”€ JSONLèª­è¾¼ (system_completeå…¨ä»¶)   â”‚
â”‚         â””â”€ å…¨ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å®Œäº†: UIé€²æ—ãƒãƒ¼ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»JSONLãƒ»ãƒ­ã‚°ãŒå®Œå…¨åŒæœŸ
```

## æ¤œè¨¼æ–¹æ³•

### 1. **é€²æ—å¾Œé€€ã®æ¤œè¨¼**

```powershell
# Streamlit UIèµ·å‹•
streamlit run apps/app_today_signals.py

# å®Ÿè¡Œä¸­ã«å„ã‚·ã‚¹ãƒ†ãƒ ã®é€²æ—ãƒãƒ¼ã‚’è¦³å¯Ÿ
# â†’ é€²æ—ãŒæˆ»ã‚‰ãªã„ã“ã¨ã‚’ç¢ºèª
```

### 2. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŒæœŸã®æ¤œè¨¼**

```powershell
# å®Ÿè¡Œå®Œäº†å¾Œã€JSONL ã¨ UI ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ¯”è¼ƒ
Get-Content logs\progress_today.jsonl | ConvertFrom-Json | Where-Object { $_.event_type -eq 'system_complete' } | Select-Object @{L='system';E={$_.data.system}},@{L='candidates';E={$_.data.candidates}}

# UIè¡¨ç¤ºã® TRDlist ã¨ Entry ãŒä¸Šè¨˜ã® candidates ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
```

### 3. **ä¸‰ç‚¹åŒæœŸã®æ¤œè¨¼**

```powershell
# JSONL final_rows
(Get-Content logs\progress_today.jsonl | ConvertFrom-Json | Where-Object { $_.event_type -eq 'pipeline_complete' }).data.final_rows

# CSV è¡Œæ•°
(Import-Csv data_cache\signals\signals_final_*.csv).Count

# UI è¡¨ç¤ºã®å„ã‚·ã‚¹ãƒ†ãƒ  Entry åˆè¨ˆ
# â†’ 3ã¤ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
```

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

- âœ… **é€²æ—å¾Œé€€ã®å®Œå…¨é˜²æ­¢**: å€¤ãŒå‰å›ã‚ˆã‚Šå°ã•ã„å ´åˆã¯æ›´æ–°ã•ã‚Œãªã„
- âœ… **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**: JSONL é€²æ—ã‚¤ãƒ™ãƒ³ãƒˆã¨ UI ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå¸¸ã«åŒæœŸ
- âœ… **ä¸‰ç‚¹åŒæœŸ**: JSONLãƒ»ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ãƒ»CSVãƒ»UI é€²æ—ãƒãƒ¼ãŒå®Œå…¨ä¸€è‡´
- âœ… **ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§**: æ¤œè¨¼ãƒ‘ãƒãƒ«ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºã®ä¸¡æ–¹ã§é€²æ—ã‚’ç¢ºèªå¯èƒ½

## ä»Šå¾Œã®æ”¹å–„æ¡ˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

1. **ä¸¦åˆ—å®Ÿè¡Œã®æœ€é©åŒ–**: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç«¶åˆã‚’æ¸›ã‚‰ã™ãŸã‚ã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹
2. **JSONL è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰**: WebSocket/polling ã§ UI ãŒè‡ªå‹•çš„ã« JSONL ã‚’è¿½è·¡
3. **è©³ç´°ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ‰**: é€²æ—æ›´æ–°ã®è©³ç´°å±¥æ­´ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰

## å‚è€ƒ

- JSONL é€²æ—ã‚¤ãƒ™ãƒ³ãƒˆä»•æ§˜: [docs/technical/progress_events.md](progress_events.md) (å­˜åœ¨ã™ã‚‹å ´åˆ)
- æ¤œè¨¼ãƒ‘ãƒãƒ«ä½¿ç”¨æ–¹æ³•: UI ä¸Šã®ã€ŒğŸ” æ¤œè¨¼: é€²æ—ã‚¤ãƒ™ãƒ³ãƒˆ (JSONL)ã€å±•é–‹ãƒ‘ãƒãƒ«
