# 実行全体の流れ

> **ナビゲーション**: [📋 処理フロー一覧](./README.md) | [次へ: 基礎データ読込 →](./2.%20基礎データ読込フェーズ.md)

「▶ 本日のシグナル実行」ボタン押下で execute_today_signals が起動し、必要な指標日数を見積もった上でシンボルごとの価格データを集約し、compute_today_signals（scripts/run_all_systems_today.py）に処理を委譲します。

## 1. 対象シンボル準備フェーズ (Phase 0)

- **主な処理**: 事前指定銘柄が無ければ universe_auto.txt や data_cache からユニバースを生成し、SPY を強制的に追加した上で進捗を初期化します。

- **必要指標／データ**: 当フェーズでは指標列は不要ですが、後工程で使う指標日数（ROC200 など）の最大値にバッファを加えた行数が算出され、以降のデータ取得量の基準になります。

- **データソース**: load_universe_file() は data/universe_auto.txt を、build_universe_from_cache() は data_cache/base 等のキャッシュ CSV を参照してユニバースを構築します

### 1.1. 最新営業日チェック（鮮度検証）

**目的**: rolling キャッシュが直近営業日のデータを持っているか検証し、stale（古い）データの銘柄を処理対象から除外します。

**処理内容**:

1. シグナル基準日（signal_base_day = 前営業日）を算出
2. 各銘柄の rolling キャッシュ最終日と比較
3. 最終日が基準日でない銘柄を除外リストに追加
4. 除外理由を分類（デリバティブ / データ欠損 / その他）
5. 除外銘柄リストを `logs/excluded_symbols_YYYYMMDD.csv` に保存
6. 進捗イベント送出（`logs/progress_today.jsonl` に除外統計を記録、Streamlit UI で可視化）
7. 処理対象シンボルを最新データを持つ銘柄のみに絞り込み

**SPY 鮮度チェック**: SPY キャッシュの営業日差が許容範囲（デフォルト: 2 営業日）を超えた場合、処理を強制停止します（`ctx.max_date_lag_days` で設定可能）。

**除外理由の分類**:

- `derivative_suffix`: デリバティブ系銘柄（W/R/U 末尾）
- `rolling_missing_date`: full には基準日データがあるが rolling にはない
- `both_missing_date`: full にも rolling にも基準日データが存在しない
- `date_parse_failure`: 日付列はあるが解析に失敗
- `no_expected_in_full`: full_backup にも基準日データが存在しない
- `latest_row_all_nan`: rolling の最終行が全て NaN
- `full_newer_than_rolling`: full cache の方が新しいデータを持つ
- `unknown`: その他の理由

**注意**: デリバティブ判定は suffix パターンのみで行い、"CON" のような通常銘柄を誤除外しません。実際のデータ鮮度（最終日の一致）で判定するため、Bulk API でデータが取得できなかった銘柄も適切に除外されます。
**スキップ方法**: `--skip-latest-check` フラグで無効化可能（デバッグ用）

**重要**: 除外された銘柄は以降の Phase 1-6 の処理対象外となり、シグナル抽出・配分・発注の対象になりません。これにより、古いデータに基づく誤ったシグナルを防ぎます。

## 関連リンク

- [技術文書トップ](../technical/) - 全体アーキテクチャ
- [Two-Phase 処理](./two-phaze_and_rank_rule.md) - ランキングルール
- [システム仕様](../systems/) - System1-7 詳細
