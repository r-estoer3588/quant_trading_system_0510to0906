# システム候補数ゼロに関するガイド

最終更新: 2025 年 10 月 11 日

## 概要

各システムは特定の市場条件を捕捉するよう設計されており、**候補数が 0 になることは正常な動作**です。このドキュメントでは、各システムで候補が出ない理由と、それが問題ではない理由を説明します。

## 候補数ゼロが正常な理由

トレーディングシステムは「常に候補を出す」ことを目的としていません。各システムは以下の役割を持ちます:

1. **特定の市場環境を捕捉** - 各システムは異なる市場局面(トレンド、ボラティリティ、モメンタム等)に最適化
2. **厳格な条件でフィルタリング** - 期待値の低いトレードを排除するため、高い閾値を設定
3. **市場環境による変動** - 相場状況によって候補数は自然に増減

**重要**: 候補数 0 = エラーではなく、「今はその戦略に適した市場環境ではない」という正常なシグナル。

## システム別の候補数ゼロ理由

### System1 (Long Momentum - ROC200)

**条件**:

- Filter: SPY > SMA100, Close >= 5, DV20 >= 50M
- Setup: SMA25 > SMA50, SMA50 > SMA100, SMA100 > SMA150, SMA150 > SMA200, ROC200 > 0

**ゼロになる場合**:

- 弱気相場で SPY < SMA100 → Filter 通過数が激減
- トレンドが弱く、SMA 階層条件を満たさない銘柄が多い

**頻度**: 稀(通常は候補が出やすいシステム)

---

### System2 (Short ADX Surge)

**条件**:

- Filter: SPY < SMA100, Low >= 5, DV50 > 1M
- Setup: ADX7 > 40

**ゼロになる場合**:

- **ADX7 > 40 は非常に強いトレンド条件** → 該当銘柄が少ない
- 強気相場で SPY > SMA100 → Filter 通過数がゼロ

**頻度**: 高(ADX7 > 40 は稀な条件)

**注記**: ADX(Average Directional Index)が 40 を超えるのは、極めて強いトレンドが発生している時のみ。通常の市場では ADX 20-30 程度。

---

### System3 (Long 3-Day Decline)

**条件**:

- Filter: SPY > SMA100, Close >= 3, DV20 >= 50M
- Setup: 3 日連続下落(drop3d == True)

**ゼロになる場合**:

- 強い上昇相場で 3 日連続下落する銘柄がない
- Filter 通過銘柄が少ない(SPY < SMA100 の時)

**頻度**: 中(3 日連続下落は比較的稀)

---

### System4 (Long RSI4 Oversold)

**条件**:

- Filter: SPY > SMA100, Close >= 3, DV20 >= 100M
- Setup: RSI4 < 10

**ゼロになる場合**:

- **RSI4 < 10 は極端な売られ過ぎ条件** → 該当銘柄が少ない
- 強い上昇相場で RSI が高水準を維持

**頻度**: 高(RSI4 < 10 は非常に稀)

**注記**: RSI(Relative Strength Index)の 4 日版で 10 未満は、パニック売りや急落時のみ発生する極端な水準。通常の RSI14 で 30 未満(売られ過ぎ)よりも遥かに厳しい条件。

---

### System5 (Short ADX Surge - SPY Down)

**条件**:

- Filter: SPY < SMA100, Low >= 5, DV50 > 10M
- Setup: ADX7 > 40

**ゼロになる場合**:

- **ADX7 > 40 は非常に強いトレンド条件**(System2 と同じ)
- 強気相場で SPY > SMA100 → Filter 通過数がゼロ

**頻度**: 高(System2 と同様、ADX 条件が厳しい)

---

### System6 (Short 6-Day Surge) ⚠️ 最も厳しい条件

**条件**:

- Filter: Low >= 5, DV50 > 10M
- Setup: **return_6d > 0.20** (6 日間で 20%以上上昇), uptwodays == True

**ゼロになる場合**:

- **6 日間で 20%上昇は極めて稀** → ほとんどの市場環境で該当銘柄なし
- 通常の市場では、6 日間で 5-10%上昇でも大きな動き

**頻度**: 非常に高(ほとんどの日で候補ゼロ)

**詳細説明**:

| 期間   | 上昇率      | 市場での頻度 | System6 条件    |
| ------ | ----------- | ------------ | --------------- |
| 6 日間 | 5%          | よくある     | ❌ (閾値未満)   |
| 6 日間 | 10%         | 時々ある     | ❌ (閾値未満)   |
| 6 日間 | 15%         | 稀           | ❌ (閾値未満)   |
| 6 日間 | **20%以上** | **極めて稀** | ✅ (条件クリア) |

**20%上昇の意味**:

- 年率換算: 約 3000%以上(非現実的な数値だが、短期では発生し得る)
- IPO 直後の銘柄、大きなニュース(M&A、決算サプライズ等)時に限定
- ボラティリティショック時(VIX 急騰時など)

**設計思想**:

- System6 は「過熱した銘柄のショート(空売り)」を狙う戦略
- 極端に上昇した銘柄は平均回帰(Mean Reversion)しやすい
- したがって、**候補が少ないことが正常** → 過熱銘柄は常に存在するわけではない

**実装詳細**:

```python
# common/system_setup_predicates.py::system6_setup_predicate()
def system6_setup_predicate(row: pd.Series) -> bool:
    return_6d = _to_float(row.get("return_6d"))
    uptwo = bool(row.get("uptwodays") or row.get("UpTwoDays"))
    return (return_6d > 0.20) and uptwo  # 20% = 0.20
```

**典型的な候補数**:

- 平常時: 0 銘柄(90%以上の日)
- 相場変動時: 0-5 銘柄
- 極端な局面: 5-20 銘柄(稀)

---

### System7 (SPY Fixed)

**条件**:

- Filter: symbol == "SPY"のみ
- Setup: 特定の SPY 条件

**ゼロになる場合**:

- SPY の Setup 条件を満たさない日

**頻度**: 中(SPY 固定なので、1 銘柄のみ判定)

---

## テスト環境での候補数

### Mini Mode (10 銘柄)

mini モード(`--test-mode mini`)では、わずか 10 銘柄しかテストしないため、候補数ゼロは**極めて正常**です:

| System  | 候補数(mini) | 理由                                         |
| ------- | ------------ | -------------------------------------------- |
| System1 | 0-10         | ROC200 条件は通過しやすいが、10 銘柄では少数 |
| System2 | 0            | ADX7 > 40 は 10 銘柄中 0 がデフォルト        |
| System3 | 0            | 3 日連続下落は 10 銘柄中 0-1 程度            |
| System4 | 0            | RSI4 < 10 は 10 銘柄中 0 がデフォルト        |
| System5 | 0            | ADX7 > 40 は 10 銘柄中 0 がデフォルト        |
| System6 | 0            | return_6d > 20%は 10 銘柄中 0 がデフォルト   |
| System7 | 0-1          | SPY 固定、条件次第                           |

### Quick Mode (50 銘柄)

50 銘柄でも、厳しい条件のシステムは候補ゼロが普通です。

### Sample Mode (100 銘柄)

100 銘柄なら、System1/3 でそこそこ候補が出始めますが、System2/4/5/6 は依然としてゼロが多いです。

### 本番環境 (~6000 銘柄)

本番では全銘柄を対象とするため、候補が出る確率が上がります:

| System  | 候補数(本番目安) | 備考                 |
| ------- | ---------------- | -------------------- |
| System1 | 5-20             | 最も候補が出やすい   |
| System2 | 0-5              | ADX 条件が厳しい     |
| System3 | 2-10             | 3 日下落は比較的発生 |
| System4 | 0-3              | RSI4 条件が厳しい    |
| System5 | 0-5              | ADX 条件が厳しい     |
| System6 | **0-2**          | **最も候補が少ない** |
| System7 | 0-1              | SPY 固定             |

## エラーとの区別

### 正常な候補数ゼロ

以下の条件を満たす場合、候補数ゼロは**正常**:

1. ✅ Setup 通過数が 0 だが、エラーログがない
2. ✅ Filter 通過数は 0 以上(Filter は機能している)
3. ✅ ログに「No candidates passed setup」と表示
4. ✅ Diagnostics に「setup_predicate_count=0」と記録

**ログ例(正常)**:

```
[system6] Setup 0 == Final 0
セットアップ結果: system6=0銘柄
```

### 異常なエラー状態

以下の場合は**問題あり**:

1. ❌ Python 例外(ValueError, KeyError 等)が発生
2. ❌ Filter 通過数も 0(データロード失敗の可能性)
3. ❌ ログに「ERROR」や「exception」が含まれる
4. ❌ Diagnostics が記録されない(処理が途中で止まった)

**ログ例(異常)**:

```
[ERROR] System6 latest_only exception: KeyError: 'return_6d'
ValueError: year 10312 is out of range
```

## トラブルシューティング

### Q1: 候補数が常にゼロだが、これで正常?

**A**: 以下を確認してください:

1. **テストモード**: mini/quick/sample モードは少数銘柄なので、ゼロが正常
2. **市場環境**: 相場が穏やかな時期は、厳しい条件(ADX > 40 等)で候補が出ない
3. **エラーログ**: エラーがなければ正常

### Q2: System6 だけ候補が出ないのは異常?

**A**: **正常です**。System6 は`return_6d > 0.20`(20%上昇)という極端に厳しい条件のため、候補が出ない日がほとんどです。

### Q3: 本番環境でも候補ゼロが続く場合は?

**A**: 以下を確認:

1. **データ更新**: キャッシュが古くないか(`scripts/cache_daily_data.py`実行)
2. **指標計算**: `return_6d`, `ADX7`, `RSI4`等が正しく計算されているか
3. **Diagnostics**: Setup 統計を確認(`results_csv/diagnostics_snapshot_*.json`)

### Q4: 候補数を増やすには?

**A**: システムの閾値を調整する方法がありますが、**推奨しません**:

- 閾値を緩めると期待値が下がり、トレード品質が悪化
- バックテスト済みパラメータを変更すると、戦略の意味が変わる
- 候補が少ないことは「選別が厳しい」証拠であり、むしろ良いこと

**代替案**:

- 複数システムを並行稼働させ、全体で候補をカバー
- System1(最も候補が出やすい)を主軸にする

## まとめ

### 重要なポイント

1. **候補数ゼロ ≠ エラー** - 市場環境と閾値設計の結果
2. **厳しい条件は意図的** - 期待値の高いトレードのみを選別
3. **System6 は特に厳しい** - return_6d > 20%は極めて稀な条件
4. **テストモードでのゼロは正常** - 10-100 銘柄では候補が出にくい
5. **エラーログがなければ OK** - Setup=0 でも正常動作

### 関連ドキュメント

- [System6 仕様](../systems/システム6.txt) - 閾値に関する注意事項を追記済み
- [Diagnostics](./diagnostics.md) - Setup 統計の見方
- [今日のシグナル処理](../today_signal_scan/5.%20セットアップ評価フェーズ.md) - Setup 判定ロジック

---

**最終更新**: 2025 年 10 月 11 日  
**作成理由**: System6 で候補数ゼロが頻発し、正常動作との区別が必要になったため
