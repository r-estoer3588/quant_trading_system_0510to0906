name: UI snapshot check
on:
    workflow_dispatch: {}
jobs:
    ui-snapshot:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"
            - name: Install Python deps
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install npm deps
              run: |
                  npm ci
                  npx playwright install --with-deps

            - name: Start Streamlit app (background)
              run: |
                  # Start Streamlit in background on port 8501
                  nohup python -m streamlit run apps/app_today_signals.py --server.port=8501 &>/dev/null &
                  # wait for the app to be reachable
                  for i in {1..30}; do
                    if curl -sSf http://127.0.0.1:8501/ >/dev/null; then
                      echo "streamlit up"; break
                    fi
                    sleep 1
                  done

            - name: Run Playwright tests (example)
              run: |
                  # This should run your Playwright tests which interact with the Streamlit app
                  # The test clicks the main "Generate Signals" button to trigger snapshot export.
                  npm run test:ui || true

            - name: Compare UI snapshot
              run: |
                  python tools/playwright_snapshot_check.py --baseline results_csv/ui_metrics_baseline.json
